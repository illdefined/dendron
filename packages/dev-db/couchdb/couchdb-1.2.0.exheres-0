# Copyright MMXII
#     Mikael Voss <mikael+exherbo@illdefined.org>
# Distributed under the terms of the GNU General Public License v2

require systemd-service

MY_PNV="apache-${PNV}"

SUMMARY="Distributed document‚Äêoriented database"
HOMEPAGE="http://${PN}.apache.org/"
DOWNLOADS="mirror://apache/${PN}/releases/${PV}/${MY_PNV}.tar.gz"

LICENCES="Apache-2.0"
SLOT="0"
PLATFORMS="~amd64 ~x86"

DEPENDENCIES="
	build+run:
		user/couchdb
		dev-lang/erlang
		dev-libs/icu
		dev-libs/spidermonkey

	test:
		net-misc/curl"

DEFAULT_SRC_CONFIGURE_PARAMS=(
	--disable-init
	--disable-launchd
	--localstatedir="/var"
)

WORK="${WORKBASE}/${MY_PNV}"

src_prepare() {
	default

	edo sed -i \
		's/^\(localstaterundir=\).*$/\1\/run\/${package_identifier}/' \
		configure
}

src_install() {
	default

	install_systemd_files

	keepdir /etc/couchdb/{default,local}.d /var/{lib,log}/couchdb
	edo chown couchdb:couchdb "${IMAGE}"/var/{lib,log}/couchdb
	edo rmdir "${IMAGE}"/run/{couchdb,}
}
