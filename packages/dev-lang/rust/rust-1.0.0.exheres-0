# Copyright MMXV
#     Mikael Voss <mvs@nyantec.com>
# Distributed under the terms of the GNU General Public License v2

MY_PN="rustc"
MY_PNV="${MY_PN}-${PV}"

SUMMARY="Rust programming language compiler"
HOMEPAGE="http://www.rust-lang.org/"
DOWNLOADS="
    https://static.rust-lang.org/dist/${MY_PNV}-src.tar.gz
    bootstrap? (
        platform:amd64? ( https://static.rust-lang.org/stage0-snapshots/rust-stage0-2015-03-27-5520801-linux-x86_64-ef2154372e97a3cb687897d027fd51c8f2c5f349.tar.bz2 )
        platform:x86? ( https://static.rust-lang.org/stage0-snapshots/rust-stage0-2015-03-27-5520801-linux-i386-1ef82402ed16f5a6d2f87a9a62eaa83170e249ec.tar.bz2 ) )"

LICENCES="|| ( MIT Apache-2.0 )"
SLOT="0"
PLATFORMS="~amd64 ~x86"

MYOPTIONS="
    bootstrap
    clang [[ description = [ Prefer clang over gcc for building the runtime ] ]]
    system-llvm
    platform:
        amd64
        x86"

DEPENDENCIES="
    build:
        !bootstrap? ( dev-lang/rust )
        clang? ( dev-lang/clang[>=3] )
        !clang? ( sys-devel/gcc:*[>=4.7] )
        system-llvm? ( dev-lang/llvm:*[>=3.3][-shared-libs] )
        dev-lang/python:*[>=2.6&<3]
        sys-devel/make[>=3.81]"

WORK="${WORKBASE}/${MY_PNV}"

src_unpack() {
    unpack "${MY_PNV}-src.tar.gz"

    if option bootstrap
    then
        edo mkdir "${WORK}/dl"
        edo cp --reflink=auto "${FETCHEDDIR}"/rust-stage0-*.tar.bz2 "${WORK}/dl/"
    fi
}

src_configure() {
    local build="$(exhost --build)"
    local target="$(exhost --target)"

    edo ./configure \
        --build="${target/-pc-/-unknown-}" \
        --host="${target/-pc-/-unknown-}" \
        --prefix="/usr/$(exhost --target)" \
        --libdir="/usr/$(exhost --target)/lib" \
        --datadir="/usr/share" \
        --mandir="/usr/share/man" \
        --infodir="/usr/share/info" \
        $(option_enable !bootstrap local-rust) \
        $(option !bootstrap --local-rust-root="/usr/$(exhost --target)") \
        $(option_enable clang) \
        $(option system-llvm --llvm-root="/usr/$(exhost --target)")
}
